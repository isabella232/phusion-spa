<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../../polymer/polymer.html">
    <link rel="import" href="../lib/phusion-spa.html">
  </head>
  <body>

    <script>
      MockRouter = function() {
        return {
          routes: [],
          on: function(view, callback) {
            this.routes.push([view, callback]);
          },
          trigger: function(route, params, options) {
            this.path = route;
            this.routes.forEach(function(route_tuple) {
              if (route_tuple[0] == route) {
                route_tuple[1](params, options);
              }
            });
          }
        };
      };
    </script>

    <spa-routes router-class="MockRouter">
      <spa-view route="first_route"></spa-view>
      <spa-view route="second_route"></spa-view>
    </spa-routes>

    <script>
      var routes = document.querySelector('spa-routes');
      var view1 = document.querySelectorAll('spa-view')[0];
      var view2 = document.querySelectorAll('spa-view')[1];

      describe('<spa-routes>', function() {

        it('has a router', function() {
          assert.isObject(routes.router);
          expect(routes.router).to.respondTo('on');
          expect(routes.router).to.have.property('routes');
        });

        it('registers children with the route property', function() {
          var first_route = routes.router.routes[0];
          expect(first_route).to.exist;
          expect(first_route[0]).to.eq('first_route');
        });

        it('registers two children with the route property', function() {
          var second_route = routes.router.routes[1];
          expect(second_route).to.exist;
          expect(second_route[0]).to.eq('second_route');
        });

        it('switches between views on routes', function() {
          expect(view1.classList.contains("active")).to.be.false;
          expect(view2.classList.contains("active")).to.be.false;
          routes.router.trigger('first_route',{});
          expect(view1.classList.contains("active")).to.be.true;
          expect(view2.classList.contains("active")).to.be.false;
          routes.router.trigger('second_route',{});
          expect(view1.classList.contains("active")).to.be.false;
          expect(view2.classList.contains("active")).to.be.true;
          routes.router.trigger('first_route',{});
          expect(view1.classList.contains("active")).to.be.true;
          expect(view2.classList.contains("active")).to.be.false;
        });

        it('called only once when routed to same route', function() {
          var spy = sinon.spy(view1, "visit");
          routes.currentRoute = '';
          routes.router.trigger('first_route',{});
          expect(routes.router.path).to.eq('first_route');
          expect(routes.currentRoute).to.eq('first_route');
          routes.router.trigger('first_route',{});
          expect(spy.calledOnce).to.be.true;

          view1.visit.restore();
        });
      });

      describe('<spa-view>', function() {
        it('has a route property', function() {
          assert.isObject(view1);
          expect(view1).to.have.property('route');
          expect(view1.route).to.eq('first_route');
        });

        it('has a visit function', function() {
          expect(view1).to.respondTo('visit');
        });

        it('visit switches active state', function() {
          view1.visit();
          expect(view1.classList.contains("active")).to.be.true;
          view2.visit();
          expect(view2.classList.contains("active")).to.be.true;
        });

        it('leave switches active state', function() {
          view1.visit();
          expect(view1.classList.contains("active")).to.be.true;
          view1.leave();
          expect(view1.classList.contains("active")).to.be.false;
        });
      });
    </script>

  </body>
</html>
